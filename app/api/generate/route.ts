import { NextResponse } from 'next/server'

export async function POST(request: Request) {
  try {
    const { genre, mood, theme } = await request.json()

    // Создаем улучшенный промпт для генерации с акцентом на рифму
    const prompt = `Сгенерируй оригинальный ${mood} текст песни в жанре ${genre} на тему "${theme}".
    Текст должен быть сильно рифмованным, с чередованием рифм (AABB или ABAB).
    Обязательно включи яркие метафоры и образы, связанные с темой "${theme}".
    Структура: 2 куплета по 4 строки, припев из 4 строк, и третий куплет из 4 строк.
    Каждая строка должна быть ритмичной и подходить для исполнения.
    Текст должен быть уникальным, не похожим на шаблонные песни.
    Максимальная длина текста - 1000 символов.
    Текст должен быть на русском языке.`

    // Проверяем наличие API ключа для Hugging Face
    const huggingFaceToken = process.env.HUGGINGFACE_API_TOKEN

    // Если нет ключа или он пустой, используем локальную генерацию
    if (!huggingFaceToken || huggingFaceToken.trim() === '') {
      console.log('Using local lyrics generation (no API token)')
      const generatedText = generateLocalLyrics(genre, mood, theme)
      return NextResponse.json({ text: generatedText })
    }

    // Вызов Hugging Face Inference API (бесплатный)
    try {
      console.log('Attempting to use Hugging Face API')

      // Используем модель для русского языка с открытым доступом
      // Заменяем на модель, которая не требует токена или имеет более широкий доступ
      const response = await fetch(
        "https://api-inference.huggingface.co/models/ai-forever/rugpt3large_based_on_gpt2",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${huggingFaceToken}`
          },
          body: JSON.stringify({
            inputs: prompt,
            parameters: {
              max_length: 1000,
              temperature: 0.7,
              top_p: 0.9,
              do_sample: true,
              return_full_text: false
            }
          }),
        }
      )

      if (!response.ok) {
        throw new Error(`API responded with status: ${response.status}`)
      }

      const data = await response.json()

      // Hugging Face возвращает сгенерированный текст в разных форматах в зависимости от модели
      let generatedText = ""

      if (Array.isArray(data) && data.length > 0) {
        // Некоторые модели возвращают массив с объектами
        generatedText = data[0].generated_text || ""
      } else if (typeof data === 'object' && data.generated_text) {
        // Некоторые модели возвращают объект с полем generated_text
        generatedText = data.generated_text
      } else if (typeof data === 'string') {
        // Некоторые модели возвращают просто строку
        generatedText = data
      }

      // Форматируем текст, если он не содержит разделов
      if (!generatedText.includes("Куплет") && !generatedText.includes("Припев")) {
        generatedText = formatLyrics(generatedText, genre, theme)
      }

      return NextResponse.json({ text: generatedText })
    } catch (apiError) {
      console.error('API error:', apiError)
      // В случае ошибки API, используем локальную генерацию
      const generatedText = generateLocalLyrics(genre, mood, theme)
      return NextResponse.json({ text: generatedText })
    }
  } catch (error) {
    console.error('Error generating text:', error)
    return NextResponse.json(
      { error: 'Failed to generate text' },
      { status: 500 }
    )
  }
}

// Функция для локальной генерации текста песни без использования API
function generateLocalLyrics(genre: string, mood: string, theme: string): string {
  // Полностью переработанные шаблоны для разных жанров с улучшенной рифмой и большим разнообразием
  const templates = {
    rap: {
      happy: [
        // Набор 1
        "Новый день, новый шанс, на волне успеха мы летим",
        "Позитив в каждом слове, негативу не дадим",
        "Движемся вперёд, не зная преград и сомнений",
        "Каждый миг ценен, полон ярких впечатлений",
        // Набор 2
        "Рифмы льются потоком, как весенняя река",
        "Музыка в наших сердцах будет жить века",
        "Солнце светит ярко, освещая путь вперёд",
        "Этот ритм заставляет двигаться народ",
        // Набор 3
        "Мы на вершине волны, и нет пути назад",
        "Каждый куплет как алмаз, каждый бит как град",
        "Энергия бьёт через край, мы не можем стоять",
        "Этот флоу заставляет всех вокруг танцевать",
        // Набор 4
        "Мой стиль как вода, принимает любую форму",
        "Слова льются свободно, не подчиняясь норме",
        "Мысли чисты, как горный хрусталь",
        "Каждый день новый старт, каждый день как февраль",
        // Набор 5
        "Мой рэп как витамин, заряжает энергией тело",
        "Делаю своё дело, делаю его смело",
        "Позитивные вибрации на каждом шагу",
        "Я знаю, что могу, я знаю, что смогу"
      ],
      sad: [
        // Набор 1
        "В тишине ночи ищу ответы на вопросы свои",
        "Память хранит моменты, но они как миражи",
        "Сквозь туман мыслей пробиваюсь к свету надежды",
        "Но тяжесть на душе не даёт мне быть прежним",
        // Набор 2
        "Дождь за окном барабанит, как мысли в голове",
        "Слова на бумаге — единственный выход в темноте",
        "Время лечит раны, но шрамы остаются навсегда",
        "В каждой строчке боль, в каждом слове — правда",
        // Набор 3
        "Одиночество стало другом, тишина — компаньоном",
        "Воспоминания о прошлом бьют по сердцу как молотом",
        "Пустота внутри растёт с каждым днём сильнее",
        "Но я продолжаю писать, становясь мудрее",
        // Набор 4
        "Серое небо отражает состояние души",
        "Мысли как осколки стекла, острые и чужие",
        "Каждый вдох даётся с трудом, каждый шаг как подвиг",
        "В этом мире холода я ищу свой столик",
        // Набор 5
        "Слёзы на бумаге размывают чернила строк",
        "Сердце бьётся в ритме грустных нот, как молоток",
        "Память хранит то, что хочется забыть навсегда",
        "Но в этой боли рождается новая глава"
      ],
      aggressive: [
        // Набор 1
        "Бит разрывает колонки, слова как пули летят",
        "Мы не отступим, даже если нас предадут",
        "Сила в правде, а правда в каждом из нас живёт",
        "Это не просто рифмы, это жизненный оплот",
        // Набор 2
        "Громче звук, сильнее бас, мы разрушаем стены",
        "Каждый куплет — как выстрел, мы не знаем измены",
        "Улицы научили нас выживать и бороться",
        "Этот трек — как оружие, что в сердце колется",
        // Набор 3
        "Я иду напролом, не боясь преград и боли",
        "Мой рэп как ураган, сметающий всё на своём пути",
        "Слабаки отступают, сильные идут до конца",
        "Это битва за место под солнцем, и я не сдамся",
        // Набор 4
        "Мой флоу как лезвие, режет фальшь и ложь",
        "Каждое слово — правда, каждый куплет — нож",
        "Система пытается сломать, но я крепче стали",
        "Мои рифмы — это оружие против печали",
        // Набор 5
        "Адреналин в крови, огонь в глазах горит",
        "Этот трек взорвёт колонки, как динамит",
        "Я не играю по правилам, я создаю свои",
        "Мой рэп — это вызов, это крик моей души"
      ]
    },
    pop: {
      happy: [
        // Набор 1
        "Яркие краски наполняют этот мир вокруг нас",
        "Музыка громче, это наш звёздный час",
        "Танцуй со мной до утра, забудь про всё плохое",
        "Этот момент навсегда, он только наше, родное",
        // Набор 2
        "Лето в сердце, даже если за окном зима",
        "Эта мелодия сводит с ума, сводит с ума",
        "Держи мою руку и просто лети со мной",
        "В этом ритме найдём мы вечный покой",
        // Набор 3
        "Солнечный свет играет в твоих волосах",
        "Твоя улыбка ярче всех звёзд в небесах",
        "Этот день создан для нас, для нашей любви",
        "Просто будь рядом, просто меня позови",
        // Набор 4
        "Мы танцуем под дождём, не боясь промокнуть",
        "Наши сердца бьются в такт, не могут остыть",
        "Эта песня о счастье, о моментах простых",
        "О тех чувствах, что нельзя объяснить другим",
        // Набор 5
        "Каждый день как праздник, когда ты со мной",
        "Твой смех как музыка, даришь мне покой",
        "Мы создаём историю, пишем её вместе",
        "И нет ничего прекраснее этой песни"
      ],
      sad: [
        // Набор 1
        "Дождь за окном напоминает о тебе, о нас",
        "Воспоминания тают в серебряной воде сейчас",
        "Мелодия грусти звучит в тишине пустой квартиры",
        "Я вспоминаю о нас, о моменты счастья, что были милы",
        // Набор 2
        "Фотографии хранят улыбки, что больше не вернуть",
        "Песня о тебе — мой единственный путь",
        "Время не лечит, лишь учит жить с этой болью",
        "Твой голос в голове, как шёпот прибоя",
        // Набор 3
        "Осенние листья падают, как мои надежды",
        "Холодный ветер пронизывает до костей",
        "Я ищу тебя в толпе, но ты уже далеко",
        "И только музыка помогает не сойти с ума",
        // Набор 4
        "Звёзды на небе напоминают о твоих глазах",
        "Но ты теперь с другим, а я один в слезах",
        "Наша история закончилась, не начавшись толком",
        "И сердце разбивается на тысячи осколков",
        // Набор 5
        "Тихая мелодия играет в пустой комнате",
        "Твои вещи всё ещё здесь, но тебя уже нет",
        "Я пишу тебе песни, которые ты не услышишь",
        "И надеюсь, что когда-нибудь боль утихнет"
      ],
      aggressive: [
        // Набор 1
        "Разбивая стереотипы, иду напролом сквозь толпу",
        "Не важно, что скажут, свой путь я найду",
        "Громче музыка, ярче свет прожекторов",
        "На вопросы судьбы у меня готов ответ суровый",
        // Набор 2
        "Маски сброшены, правда как она есть",
        "В этом мире фальши моя песня — честь",
        "Бит сильнее, голос громче, это мой манифест",
        "Я не сдамся, даже если весь мир против, это протест",
        // Набор 3
        "Я не такая как все, и этим горжусь",
        "Мои песни — это оружие, я им не делюсь",
        "Каждый день новая битва, новый вызов судьбе",
        "И я выхожу победителем, назло тебе",
        // Набор 4
        "Хватит указывать, как мне жить и что делать",
        "Моя музыка — мои правила, я буду смелой",
        "Этот трек разорвёт все шаблоны и рамки",
        "Я не играю по правилам этой игры",
        // Набор 5
        "Сильнее, громче, ярче — вот мой девиз",
        "Не прогибаюсь под мир, мир прогнётся под меня",
        "Каждая нота — вызов, каждый куплет — борьба",
        "Я иду своим путём, и мне не нужна толпа"
      ]
    },
    rock: {
      happy: [
        // Набор 1
        "Гитарный рифф зажигает толпу, как искра пламя",
        "Мы вместе создаём эту мечту, держим знамя",
        "Руки вверх, громче крик, это наш момент",
        "Этот вечер счастья не забыть, как первый комплимент",
        // Набор 2
        "Адреналин в крови, свобода в каждом аккорде",
        "Эта музыка — наш гимн, мы с ней в одном полёте",
        "Сцена дрожит от звука наших сердец",
        "В этом ритме мы найдём жизни венец",
        // Набор 3
        "Мощный звук гитары поднимает настроение",
        "Барабаны задают ритм нашего движения",
        "Мы летим высоко, не боясь разбиться",
        "Эта музыка позволяет нам свободными быть",
        // Набор 4
        "Солнце светит ярко, освещая наш путь",
        "Рок-н-ролл в наших сердцах, его не задуть",
        "Мы живём на полную, не зная преград",
        "Каждый концерт как праздник, каждый фанат как брат",
        // Набор 5
        "Электрический заряд пробегает по венам",
        "Эта музыка лечит душу, избавляет от проблем",
        "Мы создаём историю здесь и сейчас",
        "Рок живёт в каждом из нас, это наш шанс"
      ],
      sad: [
        // Набор 1
        "Струны гитары плачут вместе со мной в ночи",
        "Тяжесть аккордов, разговор с тишиной звучит",
        "Сквозь боль и потери ищу я путь к свету",
        "Музыка лечит, даёт силы жить по завету",
        // Набор 2
        "Осколки прошлого режут память до крови",
        "В каждой ноте история несбывшейся любви",
        "Дым сигарет, пустые бутылки — декорации печали",
        "Мы были так близки, но друг друга не узнали",
        // Набор 3
        "Дождь смывает слёзы с моего лица",
        "Гитара рыдает вместе со мной без конца",
        "Тяжёлые аккорды отражают боль внутри",
        "Я пишу эту песню, чтобы выжить, понять, простить",
        // Набор 4
        "Чёрно-белый мир после твоего ухода",
        "Музыка — единственное, что даёт свободу",
        "Каждый рифф как крик души, рвущийся наружу",
        "Я изливаю боль на бумагу, чтобы не было хуже",
        // Набор 5
        "Тяжёлые аккорды разрывают тишину ночи",
        "Моя душа кричит, но губы молчат",
        "В этой песне вся боль, что я не могу высказать",
        "Рок стал моим спасением в мире мрака"
      ],
      aggressive: [
        // Набор 1
        "Мощный звук разрывает тишину, как гром небеса",
        "Бунт против системы, я не утону, вот моя полоса",
        "Гитарный рифф как крик души, рвущийся наружу",
        "Мы здесь, чтобы правду до вас донести, разрушить стужу",
        // Набор 2
        "Стены дрожат от мощи наших слов",
        "Это не просто музыка, это наш зов",
        "Против течения, против правил и запретов",
        "Наш рок — это свобода, без границ и без билетов",
        // Набор 3
        "Громче! Сильнее! Мы разрушаем барьеры!",
        "Каждый аккорд как молот, каждый удар по системе",
        "Мы не будем молчать, мы будем кричать",
        "Эта музыка — наше оружие, наша печать",
        // Набор 4
        "Огонь в глазах, ярость в сердце горит",
        "Мы не подчиняемся правилам, мы создаём свои",
        "Гитары рвут тишину, барабаны бьют как набат",
        "Это революция звука, и каждый из вас ей рад",
        // Набор 5
        "Мы разрушаем стены предрассудков и лжи",
        "Наша музыка — это вызов, это крик души",
        "Мы не боимся быть собой, говорить правду",
        "Рок — это свобода, это наша отрада"
      ]
    }
  }

  // Улучшенная функция для случайного выбора строк из массива
  // Выбирает строки из разных наборов для большего разнообразия
  const getRandomLines = (lines: string[], count: number) => {
    // Определяем размер одного набора (обычно 4 строки)
    const setSize = 4;

    // Создаем массив индексов наборов
    const setCount = Math.floor(lines.length / setSize);
    const setIndices = Array.from({ length: setCount }, (_, i) => i);

    // Перемешиваем индексы наборов
    const shuffledSetIndices = [...setIndices].sort(() => 0.5 - Math.random());

    // Выбираем случайные наборы
    const selectedSets = shuffledSetIndices.slice(0, Math.ceil(count / setSize));

    // Собираем строки из выбранных наборов
    let result: string[] = [];

    selectedSets.forEach(setIndex => {
      const startIdx = setIndex * setSize;
      const setLines = lines.slice(startIdx, startIdx + setSize);

      // Выбираем случайные строки из набора
      const shuffledSetLines = [...setLines].sort(() => 0.5 - Math.random());
      result = result.concat(shuffledSetLines.slice(0, Math.min(2, setSize)));
    });

    // Перемешиваем результат и обрезаем до нужного количества
    return result.sort(() => 0.5 - Math.random()).slice(0, count);
  };

  // Выбираем шаблоны для указанного жанра и настроения
  const genreTemplates = templates[genre as keyof typeof templates] || templates.pop;
  const moodVerses = genreTemplates[mood as keyof typeof genreTemplates] || genreTemplates.happy;

  // Создаем гораздо более разнообразные и рифмованные припевы на основе темы и жанра
  const chorusTemplates = {
    rap: [
      [
        `${theme} - в каждом вздохе, в каждом слове моём`,
        `${theme} - это пламя, что горит день за днём`,
        `Снова и снова к этому возвращаюсь я`,
        `${theme} - это путь мой, моя история`
      ],
      [
        `Когда ${theme} в сердце живёт, не страшна беда`,
        `Этот огонь не погаснет никогда`,
        `Сквозь года пронесу я эту веру с собой`,
        `${theme} даёт силы, дарит душе покой`
      ],
      [
        `${theme} как воздух нужно мне каждый день`,
        `Это не просто слово, это жизни моей стержень`,
        `Без этого нет смысла, нет пути вперёд`,
        `${theme} - это то, что меня вечно ведёт`
      ],
      [
        `Эй, ${theme} - это то, что движет нами`,
        `Бит качает, слова льются сами`,
        `Каждый день на этой сцене жизни`,
        `${theme} - наш компас, наши мысли`
      ],
      [
        `${theme} в моей крови, ${theme} в моих венах`,
        `Это не просто слова, это перемены`,
        `Каждый день новый шаг, новый вызов`,
        `${theme} - мой девиз, моя жизнь, мой призыв`
      ]
    ],
    pop: [
      [
        `О-о-о, ${theme} - это наш свет в ночи`,
        `О-о-о, ${theme} - это ключ от любви`,
        `Танцуй со мной, пока играет эта песня`,
        `${theme} навсегда в моём сердце, вместе`
      ],
      [
        `${theme} зажигает огонь в моей душе`,
        `Этот ритм заставляет сердце биться сильнее`,
        `Держи меня за руку, мы пройдём этот путь`,
        `${theme} - это то, что нельзя обмануть`
      ],
      [
        `Каждый день как новая страница`,
        `${theme} помогает мне не останавливаться`,
        `Этот мир полон красок и чудес`,
        `С ${theme} я поднимаюсь до небес`
      ],
      [
        `Ла-ла-ла, ${theme} - это наш гимн`,
        `Ла-ла-ла, мы летим, мы парим`,
        `Этот момент останется с нами навсегда`,
        `${theme} - это наша яркая звезда`
      ],
      [
        `${theme} - это то, что нас объединяет`,
        `Под эту мелодию душа расцветает`,
        `Вместе мы сильнее, вместе мы семья`,
        `${theme} - это ты и это я`
      ]
    ],
    rock: [
      [
        `${theme}! Громче крик, сильнее звук!`,
        `${theme}! Это наш замкнутый круг!`,
        `Разрывая цепи, ломая стены`,
        `${theme} - это наши перемены!`
      ],
      [
        `Мы верим в ${theme}, как в последний шанс`,
        `Это не просто слова, это наш альянс`,
        `Гитары рвут тишину на части`,
        `${theme} - это наше настоящее счастье`
      ],
      [
        `${theme} как гром среди ясного неба`,
        `Мощный рифф пронзает тело`,
        `Это больше чем музыка, больше чем слова`,
        `${theme} - это наша свобода`
      ],
      [
        `Огонь ${theme} горит в наших сердцах`,
        `Не погаснет никогда, не превратится в прах`,
        `Эта сила ведёт нас вперёд`,
        `${theme} - это наш код, наш оплот`
      ],
      [
        `${theme}! ${theme}! Кричи со мной!`,
        `${theme}! ${theme}! Это наш бой!`,
        `Против системы, против правил`,
        `${theme} - это то, что нас исправит`
      ]
    ]
  };

  // Выбираем случайный шаблон припева в зависимости от жанра
  const genreChorusTemplates = chorusTemplates[genre as keyof typeof chorusTemplates] || chorusTemplates.pop;
  const chorusIndex = Math.floor(Math.random() * genreChorusTemplates.length);
  const chorus = genreChorusTemplates[chorusIndex];

  // Создаем гораздо более разнообразные строки для куплетов в зависимости от жанра и настроения
  const customLinesTemplates = {
    rap: {
      happy: [
        `${theme} в моих мыслях, как звезда в ночном небе`,
        `Это больше чем слова, это часть моей судьбы`,
        `С ${theme} я познал, что значит настоящая жизнь`,
        `Каждый день новый шаг, ${theme} указывает путь`,
        `${theme} - это то, что даёт мне силы не сдаваться`,
        `Через все испытания, через все преграды вместе`,
        `В позитивном настроении продолжаю свой путь к мечте`,
        `Рэп музыка в сердце, ${theme} в душе навсегда`,
        `${theme} как компас ведёт меня по жизни`,
        `Каждый бит, каждый такт наполнен этим смыслом`,
        `Мы на волне успеха, нет пути назад`,
        `${theme} - это то, чему каждый будет рад`
      ],
      sad: [
        `${theme} оставляет следы в моей душе`,
        `Как шрамы на сердце, не исчезнут никогда`,
        `В тишине ночи думаю о том, что было и что будет`,
        `${theme} - это боль, которую не каждый осудит`,
        `Сквозь туман воспоминаний ищу свет`,
        `${theme} как призрак преследует много лет`,
        `Слова на бумаге - единственный выход`,
        `${theme} в каждой строчке, в каждом вздохе`
      ],
      aggressive: [
        `${theme} как оружие в моих руках`,
        `Не остановлюсь, пока не исчезнет страх`,
        `Бит разрывает колонки, слова режут как нож`,
        `${theme} - это правда, а не ложь`,
        `Против системы, против правил игры`,
        `${theme} даёт силы для этой борьбы`,
        `Каждый куплет как выстрел в упор`,
        `${theme} - мой приговор, мой договор`
      ]
    },
    pop: {
      happy: [
        `${theme} как яркий свет в моей жизни`,
        `С тобой каждый день наполнен смыслом`,
        `Танцуй со мной под эту мелодию любви`,
        `${theme} в моём сердце, ты только позови`,
        `Этот ритм заставляет двигаться вперёд`,
        `${theme} как магия, что нас вместе ведёт`,
        `Держи мою руку, мы пройдём этот путь`,
        `${theme} - это то, что нельзя обмануть`
      ],
      sad: [
        `${theme} оставило след в моей душе`,
        `Как дождь за окном в холодный вечер`,
        `Воспоминания о тебе не дают мне уснуть`,
        `${theme} в моём сердце проложило свой путь`,
        `Мелодия грусти звучит в тишине`,
        `${theme} как шёпот в ночной темноте`,
        `Фотографии хранят улыбки, что не вернуть`,
        `${theme} научило меня, как дальше жить и дышать`
      ],
      aggressive: [
        `${theme} даёт мне силы идти против всех`,
        `Не важно, что скажут, я знаю свой успех`,
        `Громче музыка, ярче свет прожекторов`,
        `${theme} - мой манифест, мой разговор`,
        `Разбивая стереотипы, иду своим путём`,
        `${theme} как знамя, что несу я днём`,
        `Маски сброшены, правда как она есть`,
        `${theme} - моя свобода, моя честь`
      ]
    },
    rock: {
      happy: [
        `${theme} как электрический разряд`,
        `Гитарный рифф заставляет сердце биться в такт`,
        `Мы вместе создаём эту историю успеха`,
        `${theme} - наш гимн, наша веха`,
        `Адреналин в крови, свобода в каждом движении`,
        `${theme} как символ нашего поколения`,
        `Сцена дрожит от мощи наших голосов`,
        `${theme} объединяет нас, и мы готовы вновь`
      ],
      sad: [
        `${theme} как тяжёлый груз на моих плечах`,
        `Струны гитары плачут в ночной тиши`,
        `Осколки прошлого режут память до крови`,
        `${theme} - история несбывшейся любви`,
        `Сквозь боль и потери ищу свой путь`,
        `${theme} не даёт мне отдохнуть и уснуть`,
        `Музыка лечит, даёт силы жить дальше`,
        `${theme} научило меня быть настоящим, без фальши`
      ],
      aggressive: [
        `${theme}! Громче крик, сильнее звук!`,
        `Мощный рифф разрывает порочный круг`,
        `Бунт против системы, против правил игры`,
        `${theme} - наше оружие в этой борьбе`,
        `Стены дрожат от мощи наших слов`,
        `${theme} как знамя революции готов`,
        `Против течения, против запретов и оков`,
        `${theme} - это свобода, без границ и без оков`
      ]
    }
  };

  // Выбираем шаблоны строк в зависимости от жанра и настроения
  const genreCustomLines = customLinesTemplates[genre as keyof typeof customLinesTemplates] || customLinesTemplates.pop;
  const moodCustomLines = genreCustomLines[mood as keyof typeof genreCustomLines] || genreCustomLines.happy;

  // Смешиваем строки из шаблонов и общие строки для большего разнообразия
  const commonCustomLines = [
    `${theme} в моих мыслях, как звезда в ночном небе`,
    `Это больше чем слова, это часть моей судьбы`,
    `С ${theme} я познал, что значит настоящая жизнь`,
    `Каждый день новый шаг, ${theme} указывает путь`,
    `${theme} - это то, что даёт мне силы не сдаваться`,
    `Через все испытания, через все преграды вместе`,
    `В ${mood} настроении продолжаю свой путь к мечте`,
    `${genre} музыка в сердце, ${theme} в душе навсегда`
  ];

  // Объединяем специфичные и общие строки
  const customLines = [...moodCustomLines, ...commonCustomLines];

  // Формируем текст песни с большим разнообразием
  return `
# ${genre.toUpperCase()} - ${theme}

## Куплет 1
${getRandomLines(moodVerses, 2).join('\n')}
${getRandomLines(customLines, 2).join('\n')}

## Припев
${chorus[0]}
${chorus[1]}
${chorus[2]}
${chorus[3]}

## Куплет 2
${getRandomLines(moodVerses, 2).join('\n')}
${getRandomLines(customLines, 2).join('\n')}

## Припев
${chorus[0]}
${chorus[1]}
${chorus[2]}
${chorus[3]}

## Куплет 3
${getRandomLines(moodVerses, 2).join('\n')}
${getRandomLines(customLines, 2).join('\n')}
  `
}

// Функция для форматирования сырого текста в структуру песни
function formatLyrics(rawText: string, genre: string, theme: string): string {
  // Разбиваем текст на строки
  const lines = rawText.split('\n').filter(line => line.trim().length > 0)

  // Если текст слишком короткий, используем локальную генерацию
  if (lines.length < 12) {
    return generateLocalLyrics(genre, 'happy', theme)
  }

  // Функция для добавления рифмы к строкам
  const enhanceRhymes = (textLines: string[]) => {
    // Простые рифмующиеся окончания
    const rhymePairs = [
      ['ать', 'дать'], ['ить', 'быть'], ['ать', 'знать'],
      ['ой', 'мой'], ['ет', 'свет'], ['ать', 'стать'],
      ['ой', 'покой'], ['ать', 'ждать'], ['ить', 'жить'],
      ['ать', 'сказать'], ['ой', 'судьбой'], ['ать', 'искать']
    ];

    return textLines.map((line, index) => {
      // Для каждой второй строки пытаемся добавить рифму к предыдущей
      if (index % 2 === 1 && index > 0) {
        const prevLine = textLines[index - 1];
        // Ищем подходящую рифму
        for (const [end1, end2] of rhymePairs) {
          if (prevLine.endsWith(end1)) {
            // Если нашли подходящую рифму, модифицируем текущую строку
            const words = line.split(' ');
            if (words.length > 3) {
              words[words.length - 1] = words[words.length - 1].replace(/[,.!?]$/, '');
              return words.slice(0, -1).join(' ') + ' ' + end2;
            }
          }
        }
      }
      return line;
    });
  };

  // Разделяем текст на куплеты и припев
  const verse1 = enhanceRhymes(lines.slice(0, 4));
  const chorus = enhanceRhymes(lines.slice(4, 8));
  const verse2 = enhanceRhymes(lines.slice(8, 12));

  // Создаем третий куплет из оставшихся строк или генерируем новый
  let verse3;
  if (lines.length >= 16) {
    verse3 = enhanceRhymes(lines.slice(12, 16));
  } else {
    // Создаем уникальные строки для третьего куплета
    verse3 = [
      `${theme} освещает мой путь сквозь тьму`,
      `Я иду вперёд, несмотря на судьбу`,
      `Каждый день новый шаг к мечте`,
      `${genre} в моём сердце, в моей душе`
    ];
  }

  // Формируем структуру песни с улучшенной рифмой
  const formattedText = `
# ${genre.toUpperCase()} - ${theme}

## Куплет 1
${verse1.join('\n')}

## Припев
${chorus.join('\n')}

## Куплет 2
${verse2.join('\n')}

## Припев
${chorus.join('\n')}

## Куплет 3
${verse3.join('\n')}
  `

  return formattedText
}
